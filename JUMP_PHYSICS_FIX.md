# 跳跃物理修复 - 解决被挡住的问题

## 🐛 问题描述

**症状**: 玩家只能垂直起跳和降落，无法跳到目标平台

**原因分析**:
1. 跳跃弧度太平（垂直速度不够）
2. 被中间的平台阻挡
3. 原地跳后目标没有保持

**场景重现**:
```
当前平台 ← 玩家在这里
    ↓ （想跳到下面的目标）
  [障碍平台]  ← 挡住了！
    ↓
目标平台 ← 黄色指示器在这里
```

---

## ✅ 修复方案

### 1. 增加跳跃高度

**修改前**:
```gdscript
velocity = jump_direction * jump_force
velocity.y = jump_force * 0.8  # 垂直分量太低
```

**修改后**:
```gdscript
var horizontal_speed = jump_force * 0.8
var vertical_speed = jump_force * 1.2  # 增加到1.2倍！

velocity = horizontal_direction * horizontal_speed
velocity.y = vertical_speed
```

**效果**:
- 跳跃弧度更高
- 能跳过中间的障碍物
- 抛物线轨迹更明显

### 2. 根据目标高度调整

**新增逻辑**:
```gdscript
# 计算高度差
var height_diff = target_pos.y - current_pos.y

# 如果目标更高，额外增加垂直速度
if height_diff > 0:
    vertical_speed += height_diff * 2.0
```

**效果**:
- 目标平台更高时，跳得更高
- 目标平台更低时，正常跳跃
- 自适应不同高度差

### 3. 保持目标不变（原地跳时）

**关键改动**:
```gdscript
elif collider == previous_platform:
    # 跳回原平台，扣分
    game_manager.add_score(-2, false, 0.0)
    # ⚠️ 不发射landed信号，保持原目标不变
```

**效果**:
- 原地跳后，目标仍然是原来的平台
- 玩家需要重新尝试跳到目标
- 黄色指示器位置不变

---

## 🎯 跳跃物理参数

### 当前配置

| 参数 | 值 | 说明 |
|------|-----|------|
| 水平速度系数 | 0.8 | jump_force × 0.8 |
| 垂直速度系数 | 1.2 | jump_force × 1.2 |
| 高度补偿系数 | 2.0 | height_diff × 2.0 |
| 重力 | 20.0 | 下落加速度 |
| 最小跳跃力 | 5.0 | 最短蓄力 |
| 最大跳跃力 | 15.0 | 最长蓄力 |

### 跳跃轨迹示例

**短距离跳跃**（蓄力30%，jump_force=7）:
- 水平速度: 7 × 0.8 = 5.6
- 垂直速度: 7 × 1.2 = 8.4
- 最高点高度: ≈ 3.5单位
- 飞行距离: ≈ 3-4单位

**长距离跳跃**（蓄力100%，jump_force=15）:
- 水平速度: 15 × 0.8 = 12.0
- 垂直速度: 15 × 1.2 = 18.0
- 最高点高度: ≈ 8单位
- 飞行距离: ≈ 8-10单位

---

## 🧪 测试验证

### 测试场景1: 有障碍物的跳跃
```
设置:
- 当前平台: (0, 0, 0)
- 障碍平台: (2, 1, 2) ← 在中间
- 目标平台: (4, 0, 4)

预期:
- 玩家能跳过障碍物
- 成功落在目标平台
- 不会被卡住
```

### 测试场景2: 高度差跳跃
```
设置:
- 当前平台: (0, 0, 0)
- 目标平台: (5, 2, 5) ← 更高

预期:
- 垂直速度自动增加
- 能跳到更高的平台
- 弧度更陡
```

### 测试场景3: 原地跳后继续
```
操作:
1. 站在平台A
2. 原地跳（落回平台A）
3. 应该扣2分
4. 目标仍然是平台B
5. 再次跳到平台B应该加分

预期:
- 目标不变
- 黄色指示器不移动
- 可以重新尝试
```

---

## 🎮 游戏体验改进

### 改进前的问题
- ❌ 经常被中间平台挡住
- ❌ 跳跃轨迹太平
- ❌ 原地跳后目标消失
- ❌ 垂直起跳降落

### 改进后的效果
- ✅ 高抛物线跳跃
- ✅ 能跳过障碍物
- ✅ 原地跳保持目标
- ✅ 自适应高度差
- ✅ 更流畅的游戏体验

---

## ⚙️ 如果还是被挡住

### 方案A: 进一步增加垂直速度

编辑 `scripts/Player.gd:171`:
```gdscript
var vertical_speed: float = jump_force * 1.5  # 从1.2增加到1.5
```

### 方案B: 增加高度补偿

编辑 `scripts/Player.gd:175`:
```gdscript
vertical_speed += height_diff * 3.0  # 从2.0增加到3.0
```

### 方案C: 调整平台生成

编辑 `scripts/PlatformSpawner.gd:86`:
```gdscript
var min_distance_between_platforms: float = 4.0  # 从2.5增加到4.0
```
这样平台之间距离更远，不容易被挡住。

---

## 📊 物理计算说明

### 抛物线运动公式

```
水平位移: x = vx × t
垂直位移: y = vy × t - 0.5 × g × t²

其中:
vx = jump_force × 0.8 (水平速度)
vy = jump_force × 1.2 (垂直速度)
g = 20.0 (重力)
```

### 为什么1.2倍？

- **0.8倍水平**: 控制跳跃距离，不要太远
- **1.2倍垂直**: 增加高度，跳过障碍
- **比例1:1.5**: 产生优美的抛物线弧度

### 轨迹可视化

```
     ╱╲
    ╱  ╲     ← 新轨迹（1.2倍垂直）
   ╱    ╲
  ╱      ╲
 ╱________╲
 
  ______    ← 旧轨迹（0.8倍垂直）
 ╱      ╲
╱        ╲
```

---

## 🔧 代码修改总结

### 文件: scripts/Player.gd

**函数**: `release_jump()`

**关键改动**:
1. 分离水平和垂直速度计算
2. 垂直速度从0.8倍提升到1.2倍
3. 添加高度差补偿
4. 使用向量分解而非直接设置

**函数**: `on_landed()`

**关键改动**:
1. 只在跳到目标平台时发射landed信号
2. 原地跳不发射信号，保持目标
3. 添加详细的分支处理

---

**修复日期**: 2025-10-29  
**测试状态**: ✅ 语法通过  
**建议**: 实际测试，如还被挡可增加垂直速度

